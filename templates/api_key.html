<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key 管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin-top: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
        .badge-permanent {
            background-color: #28a745;
        }
        .badge-limited {
            background-color: #ffc107;
            color: #212529;
        }
        .api-key-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .api-key-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .api-key-value {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            background-color: #f1f3f4;
            padding: 0.5rem;
            border-radius: 4px;
            word-break: break-all;
        }
        .usage-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }
        .spinner-border {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">
                            <i class="fa fa-key mr-2"></i>
                            API Key 管理
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- 创建API Key按钮 -->
                        <div class="mb-4">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                                <i class="fa fa-plus mr-2"></i>
                                创建新API Key
                            </button>
                        </div>

                        <!-- API Key列表 -->
                        <div class="api-keys-list">
                            <h4>API Key 列表</h4>
                            <div id="apiKeysContainer" class="mt-3">
                                <!-- API Key列表将通过JavaScript动态加载 -->
                                <div class="text-center py-5">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载API Key列表...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建API Key模态框 -->
    <div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-labelledby="createApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createApiKeyModalLabel">创建新API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createApiKeyForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="apiKeyName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="apiKeyName" name="name" placeholder="输入API Key名称" required>
                        </div>
                        <div class="mb-3">
                            <label for="apiKeyMaxUsage" class="form-label">最大使用次数</label>
                            <input type="number" class="form-control" id="apiKeyMaxUsage" name="max_usage" placeholder="0表示无限制" min="0" value="100">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="apiKeyIsPermanent" name="is_permanent">
                            <label class="form-check-label" for="apiKeyIsPermanent">永久有效</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">创建</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 成功消息模态框 -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <i class="fa fa-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3" id="successModalMessage">操作成功</h5>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Key管理功能
        document.addEventListener('DOMContentLoaded', function() {
            // 加载API Key列表
            loadApiKeys();

            // 表单提交事件
            document.getElementById('createApiKeyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createApiKey();
            });
        });

        // 加载API Key列表
        function loadApiKeys() {
            fetch('/auth/api_key')
                .then(response => response.json())
                .then(data => {
                    renderApiKeys(data.api_keys);
                })
                .catch(error => {
                    console.error('加载API Key失败:', error);
                    document.getElementById('apiKeysContainer').innerHTML = '<div class="alert alert-danger">加载API Key失败，请刷新页面重试</div>';
                });
        }

        // 渲染API Key列表
        function renderApiKeys(apiKeys) {
            const container = document.getElementById('apiKeysContainer');
            
            if (apiKeys.length === 0) {
                container.innerHTML = '<div class="alert alert-info">暂无API Key，请创建新的API Key</div>';
                return;
            }

            let html = '';
            apiKeys.forEach(key => {
                const usagePercentage = key.is_permanent ? 0 : Math.min(100, (key.current_usage / key.max_usage) * 100);
                const badgeClass = key.is_permanent ? 'badge-permanent' : 'badge-limited';
                const badgeText = key.is_permanent ? '永久有效' : `限制使用 ${key.max_usage} 次`;
                
                html += `
                    <div class="api-key-item">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5>${key.name}</h5>
                                    <span class="badge ${badgeClass}">${badgeText}</span>
                                </div>
                                <div class="mb-2">
                                    <strong>API Key:</strong>
                                    <div class="api-key-value mt-1">${key.key}</div>
                                </div>
                                <div class="mb-1">
                                    <div class="d-flex justify-content-between">
                                        <span>使用情况:</span>
                                        <span>${key.current_usage}/${key.max_usage}</span>
                                    </div>
                                    <div class="usage-bar">
                                        <div class="usage-fill" style="width: ${usagePercentage}%"></div>
                                    </div>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                    创建时间: ${new Date(key.created_at).toLocaleString()}
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-center justify-content-end">
                                <button class="btn btn-danger btn-sm" onclick="deleteApiKey(${key.id}, '${key.name}')">
                                    <i class="fa fa-trash mr-1"></i>
                                    删除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 创建API Key
        function createApiKey() {
            const form = document.getElementById('createApiKeyForm');
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                max_usage: parseInt(formData.get('max_usage')),
                is_permanent: formData.get('is_permanent') === 'on'
            };

            fetch('/auth/api_key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.api_key) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createApiKeyModal'));
                    modal.hide();
                    
                    // 显示成功消息
                    showSuccessMessage('API Key创建成功');
                    
                    // 重置表单
                    form.reset();
                    
                    // 重新加载API Key列表
                    loadApiKeys();
                } else {
                    alert('创建失败: ' + (result.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('创建API Key失败:', error);
                alert('创建API Key失败，请重试');
            });
        }

        // 删除API Key
        function deleteApiKey(id, name) {
            if (confirm(`确定要删除API Key "${name}"吗？此操作不可恢复。`)) {
                fetch(`/auth/api_key/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.message) {
                        // 显示成功消息
                        showSuccessMessage('API Key删除成功');
                        
                        // 重新加载API Key列表
                        loadApiKeys();
                    } else {
                        alert('删除失败: ' + (result.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('删除API Key失败:', error);
                    alert('删除API Key失败，请重试');
                });
            }
        }

        // 显示成功消息
        function showSuccessMessage(message) {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            document.getElementById('successModalMessage').textContent = message;
            modal.show();
        }
    </script>
</body>
</html>